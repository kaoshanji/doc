##  请求与响应

###   URL与资源
-   概述
    -   所有的东西都有一个标准化的名字，以帮助人们建立共同认知
    -   如：书籍有ISBN号，公交车有路线号，银行账户有账户编码
    -   URL就是因特网资源的标准化名字
-   组成
```
<scheme>://<user>:<password>@<host>:<post>/<path>;<params>?<query>#<frag>
```

|位置|组件|描述|必须|示例|备注|
|----|----|----|----|----|----|
|scheme|方案|访问资源时使用的协议|是|http/ftp|访问资源协议|
|user|用户|某些方案时需要用户名|否|ftp://xxxppp:|-|
|password|密码|某些方案时需要用户名|否|ftp://xxxp:ppp|-|
|host|主机|服务器ip或主机名|是|http://192.12。。http://www..|资源地址|
|post|端口|服务器监听的端口|否|80..8088|服务器不同端口对应不同服务，对外就是访问协议|
|path|路径|服务器上资源的本地名|否|/index.html|资源根路径下子目录|
|params|参数|某些方案使用输入参数|否|uname=xxx|用`,`与其他路径分隔|
|query|查询|某些方案使用传递参数|否|uname=xxx|用`?`分隔|
|frag|片段|一小片或一部分资源的名字|否|#dd|客户端使用，页面定位|

-   示例
```
1. http://www.baidu.com // "http://" 在浏览器里默认，但是程序里必须
2. http://111.111.111.111:1111/index/html
3. ftp://xxx:ppp@ftp.xp.com/index.txt
4. ftp://xxx:ppp@ftp.xp.com/img;type=d
5. www.xxx.ppp.com/user/id=1&uname=x
6. http://www.spring.org/tool.html#drills
```


###   HTTP报文
-   概述
    -   封装此次请求响应的信息
    -   如：寄件时包装上面的寄件信息和收件信息
-   组成
    -   起始行：请求报文的起始行说明要做什么，响应报文的起始行说明发生了什么
    -   首部：向请求和响应报文中添加一些附加信息，只是一些名/值对的列表
    -   实体的主体部分：HTTP报文的负荷，要传输的内容
-   类型
    -   请求报文
    ```
    <method><request-URL><version>
    <headers>

    <entity-body>
    ```
    -   响应报文
    ```
    <version><status><reason-phrase>
    <headers>

    <entity-body>
    ```
-   详解
    -   方法(method)
        -   GET：请求服务器发送某个资源
        -   HEAD：服务器仅响应首部，不会返回实体的主体部分
        -   PUT：让服务器用请求的主体部分来创建一个由所请求的URL命名的新文档，如果存在就替换
        -   POST：表单提交数据
        -   TRACE：用于诊断，客户端可以知道请求到达服务器期间穿过的HTTP中间实体做的事情
        -   OPTIONS：请求web服务器告知其支持的各种功能
        -   DELETE：请服务器删除请求URL所指定的资源
    -   请求URL(request-URL)
        -   资源路径
    -   版本(version)
        -   HTTP版本
    -   状态码(status-code)
        -   1xx：信息提示
        -   2xx：标识成功
        -   3xx：重定向
        -   4xx：客户端错误
        -   5xx：服务器错误
    -   原因短语(eason-phrase)
        -   对状态码的说明，人类可读
    -   首部(header)：首部和方法配合，决定了客户端和服务器能做什么事情
        -   见下
    -   实体的主要部分(entity-body)
        -   文本或二进制数据
-   首部(header)
    -   通用首部
        -   Connection：允许客户端和服务器指定与请求/响应连接有关的选项
        -   Date：报文的创建时间
        -   Transfer-Encoding：报文采用的编码方式
        -   Via：报文经过的中间节点
    -   请求首部
        -   Client-IP：客户端机器IP地址
        -   Host：接收请求的服务器的主机名和端口号
        -   Referer：包含当前请求URL的文档的URL
        -   UA-*：客户端设备信息
        -   Accept：客户端和服务端逻辑参数
    -   响应首部
        -   Server：服务器应用程序软件的名称和版本
        -   Title：HTML文档的源端给出的标题
    -   实体首部
        -   Content-*：提供了有关实体及其内容的大量信息
    -   扩展首部
        -   非标准的首部，有应用程序开发者创建


###   实体和编码
-   概述
    -   HTTP内容的结构
-   组成
    -   实体：实体首部和实体主体组成，实体首部描述了报文的内容
    -   编码：对报文内容进行处理
-   详解
    -   Content-Length：指示报文实体主体的大小
        -   包含所有报文主体内容处理之后的大小，例如：压缩
        -   可以检测出服务器崩溃而导致的报文截尾，并对共享持久连接的多个报文进行正确分段
    -   Content-MD5：检测报文的完整性，防止内容被修改
        -   对内容做了所有需要的内容编码之后，还没有做任何传输编码之前，计算出来
        -   检服务器发送对实体主体运行MD5算法的结果
    -   Content-Type：说明实体主体的MIME类型
        -   说明原始实体主体的媒体类型
        -   MIME类型描述实体的基本媒体类型
        -   支持可选参数进一步说明内容的类型，如：Content-Type:text/html; charset=utf-8
        -   多部分媒体类型，见下
    -   Content-Encoding：描述服务器对实体主体编码处理的方法
    -   Accept-Encoding：客户端支持的编码方式
-   多部分媒体类型：表单文件对象上传、下载
    -   Content-Type：multipart/form-data..表单上传文件时指定`enctype`属性，请求内容是多部分
    -   Content-Type：multipart/byteranges,响应内容也是多部分
-   备注
    -   传输编码和分块编码
    -   随时间变化的实例：网站内容并不是静态，随着时间变化而指向对象的不同版本
        -   验证码和新鲜度
        -   范围请求
        -   差异编码

###   国际化
-   概述
    -   传输和处理用多种语言和字母表编写的国际化文档
    -   HTTP实体主体是二进制信息的容器
-   组成：这些首部描述实体主体的"信息盒子"里面装的是什么，即：字符和语言
    -   字符集编码
    -   语言标记
-   详解
    -   Content-Type
        -   服务端->客户端，Content-Type中的charset参数标识文档的字母表
    -   Content-Language
        -   服务端->客户端，文档的语言
    -   Accept-Charset
        -   客户端->服务器，字幕表编码算法
    -   Accept-Language
        -   客户端->服务端，用户理解的语言，值是语言标记（口语标准化字符串短语）
-   补充
    -   字符集是字符和二进制之间转换的算法
    -   数据二进制码->字符：二进制码依据编码算出字符代码，字符代码在字符集里找到对应的字符
    -   HTTP协议中的charset值是字符编码方案和编码后字符集的组合

###   内容协商与转码
-   概述
    -   单一的URL代表不同的资源(如：同一个网站页面的法语版和英语版)
-   组成
    -   Accept-Language
        -   定义每种语言的质量值，客户端优先选择数值高的版本
-   实现
    -   客户端驱动
        -   客户端发起请求，服务器发送可选项的列表，客户端选择
        -   至少要发送两次请求
    -   服务器驱动
        -   服务器检查客户端的请求首部集并决定提供那个版本的页面
        -   如果结论不是很明确（比如首部集不匹配）服务器要做猜测
    -   透明
        -   某个中间设备（如缓存代理）代表客户端进行请求协商
        -   没有相关正式的协议
-   补充
    -   转码
        -   格式转换：针对客户端设备环境输出指定内容，如无线设备查看桌面版文档
        -   信息综合：从文档中提取关键的信息片段称为信息综合，如根据小节标题生成文档的大纲
        -   内容注入：增加文档的内容，如自动广告生成器和用户跟踪系统

###   web服务器
-   概述
    -   对HTTP请求进行处理并提供响应，管理服务器提供的资源
-   实现
    -   逻辑实现HTTP协议，管理Web资源
    -   与操作系统共同负责管理TCP连接
-   组成
    -   建立连接：接受一个客户端连接，或者如果不希望与这个客户端建立连接，就将其关闭
        -   处理新连接：服务器接受客户端TCP连接，将IP地址解析出来
        -   客户端主机名识别：用"反向DNS"对大部分web服务器配置，以便将客户端IP地址转换成客户端主机名，会降低效率
        -   通过ident确定客户端用户：服务器通过ident协议找到发起HTTP连接的用户名，并不流行
    -   接收请求：从网络中读取一条HTTP请求报文
        -   报文的内部表示法：以便于操作的数据结构存储请求报文
        -   连接的输入/输出处理结构：见下
    -   处理请求：对请求报文进行解释，并采取行动
    -   访问资源：访问报文中指定的资源
        -   web服务器是资源服务器，负责发送预先创建的静态内容，以及程序所产生的动态内容
        -   请求报文中的URI映射为web服务器上内容，见下
    -   构建响应：创建带有正确首部的HTTP响应报文
        -   响应实体
        -   MIME类型
        -   重定向
    -   发送响应：将响应回送给客户端
    -   记录事务处理过程：将与完成事务有关的内容记录在一个日志文件中
-   连接的输入/输出处理结构：请求会在任意时刻到达，web服务器会不停的观察有无新的web请求
    -   单线程web服务器
        -   单线程的web服务器一次只处理一个请求，直到其完成为止
        -   一个事务处理结束之后，才去处理下一条连接
    -   多进程及多线程web服务器
        -   web服务器用多个进程或线程同时对请求进行处理
        -   会为每条连接分配一个线程/进程
        -   对线程/进程的最大数量进行限制
    -   复用I/O的服务器
        -   同时监视所有连接上的活动
        -   当连接的状态发生变化时（如：有数据可用、出现错误），就对那条连接进行少量的处理
        -   处理结束之后，将连接返回到开放连接列表中，等待下一次状态变化
        -   只有在事情可做时才会对连接进行处理
        -   在空闲连接上等待的时候并不会绑定线程和进程
    -   复用的多线程web服务器
        -   多个线程中的每一个都在观察打开的连接，并对每条连接执行少量的任务
-   请求报文中的URI映射为web服务器上内容
    -   docroot
        -   请求URI作为名字来访问web服务器文件系统中的文件，即文档的根目录(docroot)
        -   如：/specia/2018/blade.gif的请求，根目录为/usr/local/httpd/file，就会返回文件：/usr/local/httpd/file/specia/2018/blade.gif
    -   目录列表
        -   接收对目录URL的请求，其路径解析为一个目录
        -   文件目录中的index.html或index.htm的文件代表此目录
    -   动态内容资源的映射
        -   URI映射为动态资源，即映射到按需动态生成内容的程序上去
        -   应用程序服务器的web服务器会将web服务器连接到复杂的后端应用程序上去
    -   服务器端包含项
        -   如果某个资源被标识为存在服务器端包含项，服务器就会在将其发送给客户端之前对资源内容进行处理
    -   访问控制
        -   对特定资源进行访问控制

###   日志
-   概述
    -   日志的记录出于两个原因：查找服务器或代理中存在的问题，或者是生成web站点访问方式的统计信息
-   内容：只是记录事务的基本信息
    -   HTTP方法
    -   客户端和服务器的HTTP版本
    -   所请求资源的URI
    -   响应的HTTP状态码
    -   请求和响应报文的尺寸
    -   事务开始时的时间戳
    -   Referer首部和User-Agent首部的值