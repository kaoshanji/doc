#   Java虚拟机结构

要去"正确的"实现一台Java虚拟机，只需要正确读取class文件中每一条字节码指令，并且能正确执行这些指令所蕴含的操作即可。

##  class 文件

虚拟机执行文件，平台独立，强制统一字节序，字节码指令载体。

----

##  数据类型

### 原始类型

-   数值类型
    -   整数类型
    -   浮点类型
-   boolean类型
-   returnAddress类型

### 引用类型

-   类类型
-   数值类型
-   接口类型

----

##  运行时数据区

### pc寄存器

每条线程都有自己的pc寄存器，保存JVM正在执行的字节码指令的地址。

### Java虚拟机栈

每条线程都有自己私有的Java虚拟机栈，存储局部变量与一些尚未算好的结果。

### Java堆

堆是可供各个线程共享的运行时内存区域，也是供所有类实例和数组对象分配内存的区域。

在虚拟机启动时被创建，存储了被自动内存管理系统(垃圾收集器)所管理的各种对象。

### 方法区

方法区是可供各个线程共享的运行时内存区域，存储了每一个类的结构信息，例如，运行时常量池、字段和方法数据、构造函数和普通方法的字节码内容，还包括一些在类、实例、接口初始化时用到的特殊方法。

1.  运行时常量池

运行时常量池是class文件中每一个类或接口的常量池表的运行时表示形式，包括若干种不同的常量。

在加载类和接口到虚拟机时创建

2.  本地方法栈

当Java虚拟机使用其他语言(例如C语言)来实现指令集解释器时，也可以使用本地方法栈

3.  栈帧

栈帧是用来存储数据和部分过程结果的数据结构，同时也用来处理动态链接、方法返回值和异常分派。

栈帧随着方法调用而创建，随着方法结束而销毁。

栈帧的存储空间由创建他的线程分配在JVM栈之中，每个栈帧都有自己的本地变量表、操作数栈和指向当前方法所属的类的运行时常量池。

-   局部变量表

每个栈帧内存都包含一组称为局部变量表的变量列表。

一个局部变量可以保存一个类型为 boolean、byte。。的数据。

JVM使用局部变量来完成方法调用时的参数传递。

-   操作数栈

每个栈帧内部都包含一个称为操作数栈的后进先出栈。

JVM提供一些字节码指令来从局部变量表或对象实例的字段中复制常量或变量值到操作数栈中，也提供一些指令用于从操作数栈取走数据、操作数据以及把操作结果重新入栈。在调用方式时，操作数栈用来准备调用方法的参数以及接收方法返回结果。

-   动态链接

每个栈帧内部都包含一个指向当前方法所在类型的运行时常量池的引用，以便对当前方法的代码实现动态链接。

在class文件里面，一个方法若要调用其他方法，或者访问变量，则需要通过符号引用来表示，动态链接的作用就是将这些符号引用所表示的方法转换为对实际方法的直接引用。

类加载的过程中将要解析尚未被解析的符号引用，并且将对变量的访问转化为变量在程序运行时，位于存储结构中正确偏移量。

-   方法调用正常完成

正常完成是指没有抛出任何异常--包括直接从JVM中抛出的异常以及在执行时通过throw语句显式抛出的异常。

-   方法调用异常完成

异常完成是指某些指令导致了JVM抛出异常，并且JVM抛出的异常在该方法中没有办法处理，或者在执行过程中遇到 athrow 字节码指令并显式的抛出异常，同时在该方法内部没有捕获异常。

4.  对象的表示

5.  浮点算法

6.  特殊方法

在JVM层面上，Java编程语言中的构造器是以一个名为`<init>`的特殊实例初始化方法的形式出现的。

一个类或接口最多可以包含不超过一个类或接口的初始化方法，类或接口就是通过这个方法完成初始化的。

7.  异常

JVM里面的异常使用 Throwable 或其子类的实例来表示，抛异常的本质实际上是程序控制器的一种即时的、非局部的转换---从异常抛出的地方转换至处理异常的地方。

----

##  字节码指令集简介

JVM的指令由一个字节长度的、代表着某种特定操作含义的操作码以及跟随其后的零至多个代表此操作所需参数的操作数所构成。

由于每个操作码只能有一个字节长度，所以直接限制了整个指令集的最大数，字节码无法超过256种。

1.  数据类型与JVM

2.  加载和存储指令

3.  算术指令

4.  类型转换指令

5.  对象的创建与操作

6.  操作数栈管理指令

7.  控制转移指令

8.  方法调用和返回指令

9.  抛出异常

10. 同步

----

##  类库

JVM必须对Java SE 平台下的类库实现提供充足的支持。

----