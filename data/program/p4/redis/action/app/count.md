#   计数器和统计数据

监控应用程序，就需要收集信息。

-   需求

在一段时间内持续记录：某时间段内网站`点击量`、数据库处理`读写量`等这些信息，可以观察到流量的骤增或渐赠情况，预测何时需要对服务器进行升级，从而防止系统因为负荷超载而GG了。

##  计数器

构建一个工具，专门用来创建并维护计数器，也就是说，根据不同维度会创建不同的数据结构即计数器，比如：网站点击量、销量或者数据库查询等维度，每个维度下细分时间精度(如1秒、5秒等)，统计总是有时间因素。

计数器：统一管理所有统计维度

数据结构：有序集合，元素是统计的时间精度-维度的名字即某种计数器，分值是0，这样就会是一个固定的排列顺序

计数器：某个具体维度划分时间统计出来的数据。

当遍历计数器数据时就可以得到所有统计指标数据了

1.  更新计数器

计数器数据、具体统计维度数据初始化，这是根据时间区分

2.  清理旧计数器

已经将所有已知的计数器都存储到了一个有序集合里面，清理只需要遍历有序集合并删除其中的旧数据即可。

-   处理和清理旧计数器的时
    -   任何时候都有可能会有新的计数器被添加进来
    -   同一时间可能会有多个不同的清理操作在执行
    -   对于一个每天只会更新一次的计数器来说，以每分钟一次的频率尝试清理这个计数器只会浪费计算资源
    -   如果一个计数器不包含任何数据，那么程序就不应该尝试对他进行清理

执行操作以每分钟执行一次，时间精度小于一分钟的就每分钟执行一次，大于一分钟，就到时间再执行，比如，五分钟执行一次等

在对计数器执行清理操作时，程序会取出计数器记录的所有样本的开始时间，并移除那些开始时间位于指定截止时间之前的样本，清理之后的计数器最多只会保留最新的120个样本，如果一个计数器在执行清理操作之后不再包含任何样本，程序将从记录已知计数器的有序集合里面移除这个计数器的引用信息。

##  统计数据

把某个时间段内记录的数据统计分析出来形成结果：最大值、最小值、样本数量、值的和、平方之和等信息。

数据结构：有序集合，元素是统计类型(如：最大值等)，分值是结果数

统计程序在写入数据之前会进行检查，确保被记录的是当前这一个小时的统计数据，并将不属于当前这一个小时的旧数据进行归档。在此之后，程序会构建两个临时有序集合，其中一个用户保存最小值，而另一个则用户保存最大值。

##  简化统计数据的记录与发现

记录每个页面访问时长，可以在每个请求里面处理，也可以通过过滤器处理


----

