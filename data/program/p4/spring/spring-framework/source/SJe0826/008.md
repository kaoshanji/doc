# 第8章：Spring AOP概述及其实现机制


##  1、Spring AOP概述

Spring AOP采用Java作为AOP的实现语言(AOL)。

在Java语言的基础之上，Spring AOP对AOP的概念进行了适当的抽象和实现，使得每个AOP的概念都可以落到实处。

##  2、Spring AOP的实现机制

Spring AOP采用动态代理机制和字节码生成技术实现。

动态代理机制和字节码生成都是在运行期间为目标对象生成一个代理对象，而将横切逻辑织入到这个代理对象中，系统最终使用的是织入了横切逻辑的代理对象，而不是真正的目标对象。

- 设计模式之代理模式

代理处于访问者与被访问者之间，可以隔离这两者的直接关系，访问者与代理打交道就好像在跟被访问者在打交道一样，因为代理通常几乎会全权拥有被代理者的职能，代理能够处理的访问请求不必到被访问者。另外，即使代理最终要将访问请求转发给真正的被访问者，他也可以在转发访问请求之前或之后加入特定的逻辑，比如安全访问限制。

假设要对系统中所有的request()方法进行拦截，在每天午夜0点到次日6点之间，request调用不被接收，在指定方法里加入这个逻辑即可，也就是所谓的横切逻辑。

但是，系统中不一定只有一个地方有request方法，而是有很多，也需要加入这样的逻辑，那么就需要有很多很多的代理类了，而且所要添加的横切逻辑居然还一样！

- 动态代理

动态代理可以为指定的接口在系统运行期间动态地生成代理对象。

动态代理机制的实现主要由一个类和一个接口组成，即java.lang.reflect.Proxy类和java.lang.reflect.InvocationHandler接口。

如果有很多的目标对象类型，只要他们依然织入的横切逻辑相同，用RequestCtrlInvocationHandler一个类并通过Proxy为他们生成相应的动态代理实例就可以满足要求。

当Proxy动态生成的代理对象上相应的接口方法被调用时，对应的InvocationHandler就会拦截相应的方法调用，并进行相应处理。

InvocationHandler就是实现横切逻辑的地方，他是横切逻辑的载体，作用与Advice是一样的。

在使用动态代理机制实现AOP的过程中，可以在InvocationHandler的基础上细化程序结构，并根据Advice的类型，分化出对应的Advice类型的程序结构。

动态代理只能对实现了相应的Interface的类使用，如果某个类没有任何实现的Interface，就无法使用动态代理机制为其生成相应的动态代理对象。

- 动态字节码生成

使用动态字节码生成技术扩展对象行为的原理是，可以对目标对象进行继承扩展，为其生成相应的子类，而子类可以通过覆写来扩展父类的行为，只要将横切逻辑的实现放到子类中，然后让系统使用扩展后的目标对象的子类，就可以达到与代理模式相同的效果了。

不能像静态代理模式那样，为每个不同类型的目标对象都创建相应的扩展子类，所以，可以借助于CGLIB这样的动态字节码生产库，在系统运行期间动态地为目标生成相应的扩展子类。

----
